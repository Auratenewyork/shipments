from datetime import date
import datetime
from jinja2 import Template

from app import BASE_DIR
from chalicelib.easypsot_tracking import get_shipments, _get_n_days_old_orders_
from chalicelib.email import send_email
from chalicelib.late_order import LATE_ORDER_TEXT


def send_test_email(subject, message, email=None):
    if not email:
        email=['maxwell@auratenewyork.com', ]
    send_email(subject, message, email=email, from_email='care@auratenewyork.com')


def send_late_order(sale, email):
    for variant, text in LATE_ORDER_TEXT.items():
        if isinstance(sale['c'], list):
            items = []
            for i in sale['c']:
                items.extend(i.get('all_moves', []))
        else:
            items = sale['c'].get('all_moves', [])
        data = {
            'YEAR': str(date.today().year),
            'FINISH_DATE': sale['planned_date'],
            'TRACK_LINK': get_link(sale['reference']),
            'items': items,
            'TEXT': text
        }

        template = Template(open(f'{BASE_DIR}/chalicelib/template/late_order.html').read())
        result = template.render(**data)
        send_test_email("A small hiccup on our end.", result, email)


def get_link(reference):
    # return 'http://d35yf2x715pxm8.cloudfront.net/95583'
    return f"http://tracking.auratenewyork.com/{reference.replace('#', '')}?test=1"


SUBJECT = {
    3:"An update on your gold",
    12:"Quality Control = Check",
    17:"Next steps for your gold vermeil",
}


def send_mto_email(template_number, sale, email):
    if template_number == 17:
        sale = filter_vermeil(sale)
    if not sale:
        return
    if isinstance(sale['c'], list):
        items = []
        for i in sale['c']:
            items.extend(i.get('all_moves', []))
    else:
        items = sale['c'].get('all_moves', [])
    data = {
        'YEAR': str(date.today().year),
        'FINISH_DATE': sale['planned_date'],
        'TRACK_LINK': get_link(sale['reference']),
        'items': items,
    }
    template = Template(open(f'{BASE_DIR}/chalicelib/template/mto_{template_number}_days.html').read())
    result = template.render(**data)
    send_test_email( SUBJECT[template_number], result, email)


# data = {
#     'YEAR': str(date.today().year),
#     'FINISH_DATE': sale['planned_date'],
#     'TRACK_LINK': get_link(sale['reference']),
#     'items': sale['c'].get('all_moves', []),
# }

m_1 = {'id': 99360, 'party.email': 'joanne.mull@yahoo.com', 'reference': '#108648', 'planned_date': datetime.date(2021, 2, 26), 'c': {'id': 91149, 'inventory_moves': [3110689], 'order_numbers': 'SO78055 (#108648)', 'planned_date': datetime.date(2021, 2, 26), 'sale_date': datetime.date(2021, 1, 29), 'sales': [99360], 'all_moves': [{'id': 3110689, 'product': 46874, 'product.attributes_json': [], 'product.code': 'AU0427E00600', 'product.media_json': [], 'product.name': 'Loose Link Chain Ring (14K, Yellow, 6)', 'quantity': 1.0, 'vermeil': False}]}}

m_2 = {'id': 98450, 'party.email': 'wilsavage8@yahoo.com', 'reference': '#108128', 'planned_date': datetime.date(2021, 2, 24), 'c': {'id': 91070, 'inventory_moves': [3110369], 'order_numbers': 'SO77404 (#108128)', 'planned_date': datetime.date(2021, 2, 24), 'sale_date': datetime.date(2021, 1, 26), 'sales': [98450], 'all_moves': [{'id': 3110369, 'product': 4651, 'product.attributes_json': [{'attribute_display_name': 'Color', 'attribute_id': 1, 'attribute_name': 'color', 'attribute_set_id': 1, 'attribute_type': 'selection', 'id': 13384, 'product_id': 4651, 'value': 'Rose', 'value_boolean': False, 'value_char': None, 'value_date': None, 'value_datetime': None, 'value_float': None, 'value_integer': None, 'value_numeric': None, 'value_selection': 11}, {'attribute_display_name': 'Rate', 'attribute_id': 3, 'attribute_name': 'rate', 'attribute_set_id': 1, 'attribute_type': 'char', 'id': 13385, 'product_id': 4651, 'value': '14k', 'value_boolean': False, 'value_char': '14k', 'value_date': None, 'value_datetime': None, 'value_float': None, 'value_integer': None, 'value_numeric': None, 'value_selection': None}], 'product.code': 'AU0057F00000', 'product.media_json': [{'id': 52707, 'mimetype': 'image/png', 'name': 'e8d729533abf46afb30dcbd6c2649838-aurate-necklaces-icon-standard-879_f3737eac-9e2e-45cf-984e-f52cb97c8a3c.png', 'product': 4651, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/e8d729533abf46afb30dcbd6c2649838-aurate-necklaces-icon-standard-879_f3737eac-9e2e-45cf-984e-f52cb97c8a3c.png'}, {'id': 52708, 'mimetype': 'image/png', 'name': 'a164bd93602a7ae85ef2a5a7d1173baa-aurate-necklaces-icon-standard-879_86141b90-37ac-4ff0-bd1b-db923d9c8d25.png', 'product': 4651, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/a164bd93602a7ae85ef2a5a7d1173baa-aurate-necklaces-icon-standard-879_86141b90-37ac-4ff0-bd1b-db923d9c8d25.png'}, {'id': 52709, 'mimetype': 'image/png', 'name': '466338876a314be9718c427b2bb13e86-aurate-necklaces-icon-custom-733_6f1f52cb-e16d-48e9-a668-039273893b8e.png', 'product': 4651, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/466338876a314be9718c427b2bb13e86-aurate-necklaces-icon-custom-733_6f1f52cb-e16d-48e9-a668-039273893b8e.png'}, {'id': 52710, 'mimetype': 'image/png', 'name': 'eea70f957e757710a70bbbb1b04f9c5d-Print_IMG_9596-Edit_aa677ac0-049d-4be2-b5a1-2e8fcd2fe574.png', 'product': 4651, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/eea70f957e757710a70bbbb1b04f9c5d-Print_IMG_9596-Edit_aa677ac0-049d-4be2-b5a1-2e8fcd2fe574.png'}, {'id': 52711, 'mimetype': 'image/jpeg', 'name': 'd92e70263813422becb38ad6b7cf7d38-Icon_Necklace_52bdf1b3-4758-4068-bae7-7c150f9e571f.jpg', 'product': 4651, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/d92e70263813422becb38ad6b7cf7d38-Icon_Necklace_52bdf1b3-4758-4068-bae7-7c150f9e571f.jpg'}], 'product.name': 'icon-necklace-box', 'quantity': 1.0, 'vermeil': False}, {'id': 3093947, 'product': 3358, 'product.attributes_json': [{'attribute_display_name': 'Color', 'attribute_id': 1, 'attribute_name': 'color', 'attribute_set_id': 1, 'attribute_type': 'selection', 'id': 9781, 'product_id': 3358, 'value': 'Yellow', 'value_boolean': False, 'value_char': None, 'value_date': None, 'value_datetime': None, 'value_float': None, 'value_integer': None, 'value_numeric': None, 'value_selection': 7}, {'attribute_display_name': 'Zodiac Sign', 'attribute_id': 14, 'attribute_name': 'zodiac-sign', 'attribute_set_id': 1, 'attribute_type': 'char', 'id': 9782, 'product_id': 3358, 'value': 'Taurus', 'value_boolean': False, 'value_char': 'Taurus', 'value_date': None, 'value_datetime': None, 'value_float': None, 'value_integer': None, 'value_numeric': None, 'value_selection': None}, {'attribute_display_name': 'Quantity', 'attribute_id': 6, 'attribute_name': 'quantity', 'attribute_set_id': 1, 'attribute_type': 'char', 'id': 9783, 'product_id': 3358, 'value': 'Pair', 'value_boolean': False, 'value_char': 'Pair', 'value_date': None, 'value_datetime': None, 'value_float': None, 'value_integer': None, 'value_numeric': None, 'value_selection': None}], 'product.code': 'AU0351B0001B', 'product.media_json': [{'id': 33273, 'mimetype': 'image/png', 'name': 'bae1963b4431b09879abfcabb6bdbf61-IMG_5366.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/bae1963b4431b09879abfcabb6bdbf61-IMG_5366.png'}, {'id': 33274, 'mimetype': 'image/png', 'name': '4b5f540a32617575eb86a63e32ea142b-IMG_5366R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/4b5f540a32617575eb86a63e32ea142b-IMG_5366R.png'}, {'id': 33275, 'mimetype': 'image/png', 'name': '689a36c45b6e69d844535d58f22636a8-IMG_5366W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/689a36c45b6e69d844535d58f22636a8-IMG_5366W.png'}, {'id': 33276, 'mimetype': 'image/png', 'name': '8bc4423211728e0b38cb251c42b3383a-IMG_5367.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/8bc4423211728e0b38cb251c42b3383a-IMG_5367.png'}, {'id': 33277, 'mimetype': 'image/png', 'name': '627624a83cfd1b2834e51875cb79b5b2-IMG_5367R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/627624a83cfd1b2834e51875cb79b5b2-IMG_5367R.png'}, {'id': 33278, 'mimetype': 'image/png', 'name': 'efef069e10bd862c92cea03e18cfe4ce-IMG_5367W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/efef069e10bd862c92cea03e18cfe4ce-IMG_5367W.png'}, {'id': 33279, 'mimetype': 'image/png', 'name': '3e5b2a3a0788fc1ec273c90ba38c53dc-IMG_5368.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/3e5b2a3a0788fc1ec273c90ba38c53dc-IMG_5368.png'}, {'id': 33280, 'mimetype': 'image/png', 'name': '8ee990a4eed7d02d048e590dc6ffe311-IMG_5368R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/8ee990a4eed7d02d048e590dc6ffe311-IMG_5368R.png'}, {'id': 33281, 'mimetype': 'image/png', 'name': '66204a5f6e077d0e42e390bf5ddc56e3-IMG_5368W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/66204a5f6e077d0e42e390bf5ddc56e3-IMG_5368W.png'}, {'id': 33282, 'mimetype': 'image/png', 'name': '6ae5d891c5b873520d1b433db03edd7d-IMG_5369.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/6ae5d891c5b873520d1b433db03edd7d-IMG_5369.png'}, {'id': 33283, 'mimetype': 'image/png', 'name': 'e959ca79b149598baf0f4f4f008a459f-IMG_5369R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/e959ca79b149598baf0f4f4f008a459f-IMG_5369R.png'}, {'id': 33284, 'mimetype': 'image/png', 'name': '4be54f84c86814e34aa74892d9c76abf-IMG_5369W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/4be54f84c86814e34aa74892d9c76abf-IMG_5369W.png'}, {'id': 33285, 'mimetype': 'image/png', 'name': '9ce5445aa66d162395e405513bfde963-IMG_5370.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/9ce5445aa66d162395e405513bfde963-IMG_5370.png'}, {'id': 33286, 'mimetype': 'image/png', 'name': '455e7feb52c4fd157f13b4dea5d25984-IMG_5370R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/455e7feb52c4fd157f13b4dea5d25984-IMG_5370R.png'}, {'id': 33287, 'mimetype': 'image/png', 'name': '5448532885ad738b0ee41273980ad478-IMG_5370W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/5448532885ad738b0ee41273980ad478-IMG_5370W.png'}, {'id': 33288, 'mimetype': 'image/png', 'name': '99869e2be0b01d69210ec6fd6a6c83d1-IMG_5371.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/99869e2be0b01d69210ec6fd6a6c83d1-IMG_5371.png'}, {'id': 33289, 'mimetype': 'image/png', 'name': '880ee82f29decea17f15693df50d21e0-IMG_5371R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/880ee82f29decea17f15693df50d21e0-IMG_5371R.png'}, {'id': 33290, 'mimetype': 'image/png', 'name': 'c55bb3b1d86fba0e4036b5bef7ce2fa6-IMG_5371W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/c55bb3b1d86fba0e4036b5bef7ce2fa6-IMG_5371W.png'}, {'id': 33291, 'mimetype': 'image/png', 'name': 'b2c7c116ebb4338c8b651e6aa698af9f-IMG_5372.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/b2c7c116ebb4338c8b651e6aa698af9f-IMG_5372.png'}, {'id': 33292, 'mimetype': 'image/png', 'name': '73f82358213bf79bf41b0284a24f6cce-IMG_5372R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/73f82358213bf79bf41b0284a24f6cce-IMG_5372R.png'}, {'id': 33293, 'mimetype': 'image/png', 'name': '86e4e14cc2489de9696defd3032feb9b-IMG_5372W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/86e4e14cc2489de9696defd3032feb9b-IMG_5372W.png'}, {'id': 33294, 'mimetype': 'image/png', 'name': '170da99eace08a3344f1f66afa5927e2-IMG_5373.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/170da99eace08a3344f1f66afa5927e2-IMG_5373.png'}, {'id': 33295, 'mimetype': 'image/png', 'name': '5f073c50986ef5b47953f4f970c2516f-IMG_5373R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/5f073c50986ef5b47953f4f970c2516f-IMG_5373R.png'}, {'id': 33296, 'mimetype': 'image/png', 'name': '3aa0e46a47f8b8f1dd7c64edf1dffffb-IMG_5373W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/3aa0e46a47f8b8f1dd7c64edf1dffffb-IMG_5373W.png'}, {'id': 33297, 'mimetype': 'image/png', 'name': '57afdb5f4f13ce5fc99a12155bec4afb-IMG_5374.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/57afdb5f4f13ce5fc99a12155bec4afb-IMG_5374.png'}, {'id': 33298, 'mimetype': 'image/png', 'name': '32ec118ad6a937df2685dd098e405571-IMG_5374R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/32ec118ad6a937df2685dd098e405571-IMG_5374R.png'}, {'id': 33299, 'mimetype': 'image/png', 'name': 'b98f1288107e1e765ccb1de206838b03-IMG_5374W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/b98f1288107e1e765ccb1de206838b03-IMG_5374W.png'}, {'id': 33300, 'mimetype': 'image/png', 'name': '82e5c038f37b183d984f854fa2f98c7b-IMG_5375.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/82e5c038f37b183d984f854fa2f98c7b-IMG_5375.png'}, {'id': 33301, 'mimetype': 'image/png', 'name': 'ee7a9b722649202d171d57ddad599efb-IMG_5375R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/ee7a9b722649202d171d57ddad599efb-IMG_5375R.png'}, {'id': 33302, 'mimetype': 'image/png', 'name': '4aee99b4995b1ece198d24a4f8c12d7f-IMG_5375W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/4aee99b4995b1ece198d24a4f8c12d7f-IMG_5375W.png'}, {'id': 33303, 'mimetype': 'image/png', 'name': 'c2e408b3208a7ecf6e513377f090a3c9-IMG_5376.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/c2e408b3208a7ecf6e513377f090a3c9-IMG_5376.png'}, {'id': 33304, 'mimetype': 'image/png', 'name': 'ea279d5dc9e9d8aec7b9954cea1a7366-IMG_5376R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/ea279d5dc9e9d8aec7b9954cea1a7366-IMG_5376R.png'}, {'id': 33305, 'mimetype': 'image/png', 'name': '80c6db3f70dcca6216a905a9e79ee731-IMG_5376W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/80c6db3f70dcca6216a905a9e79ee731-IMG_5376W.png'}, {'id': 33306, 'mimetype': 'image/png', 'name': 'e0aacf580c7648042fceba4a50996b6b-IMG_5377.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/e0aacf580c7648042fceba4a50996b6b-IMG_5377.png'}, {'id': 33307, 'mimetype': 'image/png', 'name': 'f3be4fa167ca51d8cf3df0b1af5583c1-IMG_5377R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/f3be4fa167ca51d8cf3df0b1af5583c1-IMG_5377R.png'}, {'id': 33308, 'mimetype': 'image/png', 'name': '1abe7c48dd03881aeda0525289becf3b-IMG_5377W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/1abe7c48dd03881aeda0525289becf3b-IMG_5377W.png'}, {'id': 33309, 'mimetype': 'image/png', 'name': '8d00d1a88643932154002bef72700b3b-IMG_5381.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/8d00d1a88643932154002bef72700b3b-IMG_5381.png'}, {'id': 33310, 'mimetype': 'image/png', 'name': '255a0271e1e80c3c1cfa4c864be47002-IMG_5381R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/255a0271e1e80c3c1cfa4c864be47002-IMG_5381R.png'}, {'id': 33311, 'mimetype': 'image/png', 'name': '0b1ebff6e198cd303c87f71c20ba64d0-IMG_5381W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/0b1ebff6e198cd303c87f71c20ba64d0-IMG_5381W.png'}, {'id': 33312, 'mimetype': 'image/png', 'name': '5f38cc0bef37ee3abad1fec697dc8bc2-IMG_5382.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/5f38cc0bef37ee3abad1fec697dc8bc2-IMG_5382.png'}, {'id': 33313, 'mimetype': 'image/png', 'name': '1399e7ea8a856f4cce0009e18c9b38b5-IMG_5382R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/1399e7ea8a856f4cce0009e18c9b38b5-IMG_5382R.png'}, {'id': 33314, 'mimetype': 'image/png', 'name': '4e53e52214b4314a820776c1d9d1bb44-IMG_5382W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/4e53e52214b4314a820776c1d9d1bb44-IMG_5382W.png'}, {'id': 33315, 'mimetype': 'image/png', 'name': '98b6fd883d47eb7def60fda64efe65fc-IMG_5383-Edit.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/98b6fd883d47eb7def60fda64efe65fc-IMG_5383-Edit.png'}, {'id': 33316, 'mimetype': 'image/png', 'name': 'dcd197b1e60d8c975a04aca54ca7da81-IMG_5383-EditR.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/dcd197b1e60d8c975a04aca54ca7da81-IMG_5383-EditR.png'}, {'id': 33317, 'mimetype': 'image/png', 'name': 'ae7ce790aad3b95f81c994f99b924d21-IMG_5383-EditW.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/ae7ce790aad3b95f81c994f99b924d21-IMG_5383-EditW.png'}, {'id': 33318, 'mimetype': 'image/png', 'name': '71fcef095083f80a753a76e5427d912d-IMG_5385.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/71fcef095083f80a753a76e5427d912d-IMG_5385.png'}, {'id': 33319, 'mimetype': 'image/png', 'name': '532dfd22e9e46beae8dfe986daa52b50-IMG_5385R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/532dfd22e9e46beae8dfe986daa52b50-IMG_5385R.png'}, {'id': 33320, 'mimetype': 'image/png', 'name': 'fad9be2b9d789158574a039dcb876c70-IMG_5385W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/fad9be2b9d789158574a039dcb876c70-IMG_5385W.png'}, {'id': 33321, 'mimetype': 'image/png', 'name': '05323fe1da505a6c0e966464e3da26f7-IMG_5387.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/05323fe1da505a6c0e966464e3da26f7-IMG_5387.png'}, {'id': 33322, 'mimetype': 'image/png', 'name': 'cbafa5c568cb6459f4ae3dea40d76da5-IMG_5387R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/cbafa5c568cb6459f4ae3dea40d76da5-IMG_5387R.png'}, {'id': 33323, 'mimetype': 'image/png', 'name': '941b0e89335e0ba49379ccb856507244-IMG_5387W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/941b0e89335e0ba49379ccb856507244-IMG_5387W.png'}, {'id': 33324, 'mimetype': 'image/png', 'name': '0feb08c42b3a4c61fe6d67967f13c5ca-IMG_5391.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/0feb08c42b3a4c61fe6d67967f13c5ca-IMG_5391.png'}, {'id': 33325, 'mimetype': 'image/png', 'name': 'fa9cc8eb9ba57508c1f32aed962a478d-IMG_5391R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/fa9cc8eb9ba57508c1f32aed962a478d-IMG_5391R.png'}, {'id': 33326, 'mimetype': 'image/png', 'name': '506e1d5d1897013cb8a8792a2085a46a-IMG_5391W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/506e1d5d1897013cb8a8792a2085a46a-IMG_5391W.png'}, {'id': 33327, 'mimetype': 'image/png', 'name': '8943f4ce88bca25e84b6ac2f0c3908dd-IMG_5394.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/8943f4ce88bca25e84b6ac2f0c3908dd-IMG_5394.png'}, {'id': 33328, 'mimetype': 'image/png', 'name': 'd53851e8e84e2806806517ceec2edb4c-IMG_5394R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/d53851e8e84e2806806517ceec2edb4c-IMG_5394R.png'}, {'id': 33329, 'mimetype': 'image/png', 'name': 'afb49f953d1ba4098c8d3546b1ba5bec-IMG_5394W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/afb49f953d1ba4098c8d3546b1ba5bec-IMG_5394W.png'}, {'id': 33330, 'mimetype': 'image/png', 'name': 'd0851ec8646d2e8fa98def39d5f1e787-IMG_5400.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/d0851ec8646d2e8fa98def39d5f1e787-IMG_5400.png'}, {'id': 33331, 'mimetype': 'image/png', 'name': 'a4af1144a5e7c8fa9cdabd2aed722b1a-IMG_5400R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/a4af1144a5e7c8fa9cdabd2aed722b1a-IMG_5400R.png'}, {'id': 33332, 'mimetype': 'image/png', 'name': '6b3fd510569696a45aa91031d21bdeaa-IMG_5400W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/6b3fd510569696a45aa91031d21bdeaa-IMG_5400W.png'}, {'id': 33333, 'mimetype': 'image/png', 'name': '8bddeafc71b6f7f950d07f4245c539cd-IMG_5402.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/8bddeafc71b6f7f950d07f4245c539cd-IMG_5402.png'}, {'id': 33334, 'mimetype': 'image/png', 'name': '98e6dc56a4fd256dd40136b2ecb89173-IMG_5402R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/98e6dc56a4fd256dd40136b2ecb89173-IMG_5402R.png'}, {'id': 33335, 'mimetype': 'image/png', 'name': 'f9ea84c1e588a600a34835a7a09eddc1-IMG_5402W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/f9ea84c1e588a600a34835a7a09eddc1-IMG_5402W.png'}, {'id': 33336, 'mimetype': 'image/png', 'name': 'fefaf07156e1ac8447d78d81860fc395-IMG_5407.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/fefaf07156e1ac8447d78d81860fc395-IMG_5407.png'}, {'id': 33337, 'mimetype': 'image/png', 'name': '53211fcc612d68fd6911126df4eef3d9-IMG_5407R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/53211fcc612d68fd6911126df4eef3d9-IMG_5407R.png'}, {'id': 33338, 'mimetype': 'image/png', 'name': '714126bd231eb9ec08b1e44d19d29694-IMG_5407W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/714126bd231eb9ec08b1e44d19d29694-IMG_5407W.png'}, {'id': 33339, 'mimetype': 'image/png', 'name': 'c1d0c04a60437137ee1f42fb9abdbab4-IMG_5411.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/c1d0c04a60437137ee1f42fb9abdbab4-IMG_5411.png'}, {'id': 33340, 'mimetype': 'image/png', 'name': '43228dacf54ac5a0f06bb5a4db3fb851-IMG_5411R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/43228dacf54ac5a0f06bb5a4db3fb851-IMG_5411R.png'}, {'id': 33341, 'mimetype': 'image/png', 'name': '34088e1e0476654b7a257d31764b5d07-IMG_5411W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/34088e1e0476654b7a257d31764b5d07-IMG_5411W.png'}, {'id': 33342, 'mimetype': 'image/png', 'name': 'fbe6d7fe8c06a698e692b4d753240be8-IMG_5412.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/fbe6d7fe8c06a698e692b4d753240be8-IMG_5412.png'}, {'id': 33343, 'mimetype': 'image/png', 'name': '936d265583fd56fbc8baa869d014e5fa-IMG_5412R.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/936d265583fd56fbc8baa869d014e5fa-IMG_5412R.png'}, {'id': 33344, 'mimetype': 'image/png', 'name': '32799f2beef07df9ce8b67172e385489-IMG_5412W.png', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/32799f2beef07df9ce8b67172e385489-IMG_5412W.png'}, {'id': 33345, 'mimetype': 'image/jpeg', 'name': '4ba76ef63999476b295bcc7ed23a0eff-Web_IMG_6024-Edit.jpg', 'product': 3358, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/4ba76ef63999476b295bcc7ed23a0eff-Web_IMG_6024-Edit.jpg'}], 'product.name': 'Zodiac Stud Earrings Gold Vermeil (Taurus, Pair, Yellow)', 'quantity': 1.0, 'vermeil': True}]}}

m_3 = {'id': 99343, 'party.email': 'persaud.rajnee@gmail.com', 'reference': '#108637', 'planned_date': datetime.date(2021, 3, 1), 'c': {'id': 91136, 'inventory_moves': [3110646], 'order_numbers': 'SO78042 (#108637)', 'planned_date': datetime.date(2021, 3, 1), 'sale_date': datetime.date(2021, 1, 29), 'sales': [99343], 'all_moves': [{'id': 3110646, 'product': 19691, 'product.attributes_json': [], 'product.code': 'AU0364E00000', 'product.media_json': [], 'product.name': 'Kaleidoscope Mini Ear Cuff (14K, Yellow, )', 'quantity': 1.0, 'vermeil': False},{'id': 3095237, 'product': 46547, 'product.attributes_json': [], 'product.code': 'AU0428D00400', 'product.media_json': [], 'product.name': 'Infinity Edge Cigar Band (Vermeil, White, 4)', 'quantity': 1.0, 'vermeil': True}]}}


m_5 = {'id': 99272, 'party.email': 'claire.elmgreen@gmail.com', 'reference': '#108593', 'planned_date': datetime.date(2021, 3, 1), 'c': {'id': 91089, 'inventory_moves': [3110502, 3110501], 'order_numbers': 'SO77996 (#108593)', 'planned_date': datetime.date(2021, 3, 1), 'sale_date': datetime.date(2021, 1, 29), 'sales': [99272], 'all_moves': [{'id': 3110502, 'product': 2509, 'product.attributes_json': [{'attribute_display_name': 'Color', 'attribute_id': 1, 'attribute_name': 'color', 'attribute_set_id': 1, 'attribute_type': 'selection', 'id': 7389, 'product_id': 2509, 'value': 'Yellow', 'value_boolean': False, 'value_char': None, 'value_date': None, 'value_datetime': None, 'value_float': None, 'value_integer': None, 'value_numeric': None, 'value_selection': 7}, {'attribute_display_name': 'Rate', 'attribute_id': 3, 'attribute_name': 'rate', 'attribute_set_id': 1, 'attribute_type': 'char', 'id': 7390, 'product_id': 2509, 'value': '14k', 'value_boolean': False, 'value_char': '14k', 'value_date': None, 'value_datetime': None, 'value_float': None, 'value_integer': None, 'value_numeric': None, 'value_selection': None}, {'attribute_display_name': 'Quantity', 'attribute_id': 6, 'attribute_name': 'quantity', 'attribute_set_id': 1, 'attribute_type': 'char', 'id': 7391, 'product_id': 2509, 'value': 'Pair', 'value_boolean': False, 'value_char': 'Pair', 'value_date': None, 'value_datetime': None, 'value_float': None, 'value_integer': None, 'value_numeric': None, 'value_selection': None}], 'product.code': 'AU0149E00010', 'product.media_json': [{'id': 21539, 'mimetype': 'image/png', 'name': 'f5264585ad4b6eb1e2f5489c2d600d45-aurate-earrings-gold-huggie-custom-540.png', 'product': 2509, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/f5264585ad4b6eb1e2f5489c2d600d45-aurate-earrings-gold-huggie-custom-540.png'}, {'id': 21540, 'mimetype': 'image/png', 'name': '6406abf254fede8fe77dc0ebf1787fc0-aurate-earrings-gold-huggie-custom-187.png', 'product': 2509, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/6406abf254fede8fe77dc0ebf1787fc0-aurate-earrings-gold-huggie-custom-187.png'}, {'id': 21541, 'mimetype': 'image/png', 'name': '6cda189530d038411fc1f350a7832b6a-aurate-earrings-gold-huggie-standard-272.png', 'product': 2509, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/6cda189530d038411fc1f350a7832b6a-aurate-earrings-gold-huggie-standard-272.png'}, {'id': 21542, 'mimetype': 'image/png', 'name': '7f3afafd5ef7f90908d7a9b92285d3e1-aurate-earrings-gold-huggie-standard-189.png', 'product': 2509, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/7f3afafd5ef7f90908d7a9b92285d3e1-aurate-earrings-gold-huggie-standard-189.png'}, {'id': 21543, 'mimetype': 'image/png', 'name': '8d0add445226abdf2184fff72e1ae093-aurate-earrings-gold-huggie-standard-223.png', 'product': 2509, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/8d0add445226abdf2184fff72e1ae093-aurate-earrings-gold-huggie-standard-223.png'}, {'id': 21544, 'mimetype': 'image/png', 'name': '28d64b1d8ba4c65ad86a4f1b1be198a5-aurate-earrings-gold-huggie-standard-180.png', 'product': 2509, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/28d64b1d8ba4c65ad86a4f1b1be198a5-aurate-earrings-gold-huggie-standard-180.png'}, {'id': 21545, 'mimetype': 'image/jpeg', 'name': '745beb19124f39739b6a74aa12b4d874-KatyaAUrate-78.jpg', 'product': 2509, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/745beb19124f39739b6a74aa12b4d874-KatyaAUrate-78.jpg'}, {'id': 21546, 'mimetype': 'image/jpeg', 'name': '4505b4e5915f1de4baabeed11d2dbb0c-Solid_Gold_Huggie.jpg', 'product': 2509, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/4505b4e5915f1de4baabeed11d2dbb0c-Solid_Gold_Huggie.jpg'}], 'product.name': 'gold-huggies', 'quantity': 1.0, 'vermeil': False}, {'id': 3110501, 'product': 19697, 'product.attributes_json': [], 'product.code': 'AU0365E00000', 'product.media_json': [], 'product.name': 'Kaleidoscope Midi Gold Bar Earrings (14K, Yellow, Single |)', 'quantity': 1.0, 'vermeil': False}, {'id': 3102950, 'product': 49749, 'product.attributes_json': [], 'product.code': 'AU1020B00010', 'product.media_json': [], 'product.name': 'organic-pearl-drop-rectangle-hoops (vermeil, yellow, pair)', 'quantity': 1.0, 'vermeil': True}, {'id': 3102949, 'product': 5111, 'product.attributes_json': [{'attribute_display_name': 'Color', 'attribute_id': 1, 'attribute_name': 'color', 'attribute_set_id': 1, 'attribute_type': 'selection', 'id': 14683, 'product_id': 5111, 'value': 'Yellow', 'value_boolean': False, 'value_char': None, 'value_date': None, 'value_datetime': None, 'value_float': None, 'value_integer': None, 'value_numeric': None, 'value_selection': 7}, {'attribute_display_name': 'Rate', 'attribute_id': 3, 'attribute_name': 'rate', 'attribute_set_id': 1, 'attribute_type': 'char', 'id': 14684, 'product_id': 5111, 'value': 'Vermeil', 'value_boolean': False, 'value_char': 'Vermeil', 'value_date': None, 'value_datetime': None, 'value_float': None, 'value_integer': None, 'value_numeric': None, 'value_selection': None}, {'attribute_display_name': 'Quantity', 'attribute_id': 6, 'attribute_name': 'quantity', 'attribute_set_id': 1, 'attribute_type': 'char', 'id': 14685, 'product_id': 5111, 'value': 'Pair', 'value_boolean': False, 'value_char': 'Pair', 'value_date': None, 'value_datetime': None, 'value_float': None, 'value_integer': None, 'value_numeric': None, 'value_selection': None}], 'product.code': 'AU0323B00010', 'product.media_json': [{'id': 61220, 'mimetype': 'image/png', 'name': 'd99bfd1decdc75fd58760ce8bb488ac4-6366.png', 'product': 5111, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/d99bfd1decdc75fd58760ce8bb488ac4-6366.png'}, {'id': 61221, 'mimetype': 'image/png', 'name': '98c922f5f426861399dc7e1fba30544e-6366R.png', 'product': 5111, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/98c922f5f426861399dc7e1fba30544e-6366R.png'}, {'id': 61222, 'mimetype': 'image/png', 'name': '382b2c2550c03d85812e3b4711b55278-6366W.png', 'product': 5111, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/382b2c2550c03d85812e3b4711b55278-6366W.png'}, {'id': 61223, 'mimetype': 'image/png', 'name': '3300e340e593be0b751d6ca31d44c5f8-IMG_6371-Edit.png', 'product': 5111, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/3300e340e593be0b751d6ca31d44c5f8-IMG_6371-Edit.png'}, {'id': 61224, 'mimetype': 'image/png', 'name': '933168191e47142f2f20aec0d808ad88-IMG_6371-EditR.png', 'product': 5111, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/933168191e47142f2f20aec0d808ad88-IMG_6371-EditR.png'}, {'id': 61225, 'mimetype': 'image/png', 'name': '6edb30c19ce09c52809558976b94d40b-IMG_6371-EditW.png', 'product': 5111, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/6edb30c19ce09c52809558976b94d40b-IMG_6371-EditW.png'}, {'id': 61226, 'mimetype': 'image/jpeg', 'name': '595a3cc620acbf7ea9ffab0260bc6310-FOTO13-098.jpg', 'product': 5111, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/595a3cc620acbf7ea9ffab0260bc6310-FOTO13-098.jpg'}, {'id': 61227, 'mimetype': 'image/jpeg', 'name': 'e880a9082c069bec0376ad3b61980740-Web_IMG_6008-Edit.jpg', 'product': 5111, 'sequence': 10, 'template': None, 'url': 'https://cdn.fulfil.io/aurate/default/e880a9082c069bec0376ad3b61980740-Web_IMG_6008-Edit.jpg'}], 'product.name': 'Infinity Heart Huggie Earrings (Vermeil, Yellow, Pair)', 'quantity': 1.0, 'vermeil': True}]}}


def filter_vermeil(sale):
    new_moves = []
    if isinstance(sale['c'], list):
        items = []
        for i in sale['c']:
            items.extend(i.get('all_moves', []))
    else:
        items = sale['c'].get('all_moves', [])

    for m in items:
        if m['vermeil']:
            new_moves.append(m)
    if not new_moves:
        return
    sale['c'] = {'all_moves': new_moves}
    return sale


def run_email_tests(email=None, order_number=None):
    if order_number:
        try:
            int(order_number)
            sale_reference = "#" + order_number
        except ValueError:
            sale_reference = order_number
        test_cases = _get_n_days_old_orders_(sale_reference)
    else:
        test_cases = [m_1, m_2, m_3, m_5]
    templates = [3, 12, 17]
    for sale in test_cases:
        for template_number in templates:
            send_mto_email(template_number, sale, email)
        send_late_order(sale, email)
